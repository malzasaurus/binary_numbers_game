'use strict';

window.app = angular.module('FullstackGeneratedApp', ['ui.router', 'ui.bootstrap', 'ngAnimate']);

app.config(function ($urlRouterProvider, $locationProvider) {
    // This turns off hashbang urls (/#about) and changes it to something normal (/about)
    $locationProvider.html5Mode(true);
    // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
    $urlRouterProvider.otherwise('/');
});

app.controller('BoardCtrl', function ($window, $scope, $stateParams, players, randomNum) {

    $scope.players = players; //created in the state resolve function
    $scope.targetNum = randomNum; //determined in the state resolve function
    $scope.message = 'Target Number: ' + $scope.targetNum;
    $scope.currentTile = function (player, tile) {
        return player.activeTile === tile.index;
    };

    $scope.currentPosition = function (tile) {
        return tile.position === 1;
    };
    $scope.currentWinner = function (player) {
        if (player.currentTot === $scope.targetNum) {
            $scope.message = 'Winner: Player ' + player.playerID + '!';
            return true;
        } else {
            return false;
        }
        // return player.currentTot === $scope.targetNum;
    };

    $scope.toggle = function (player, tile) {
        if (tile.position === 0) {
            player.currentTot += tile.bit;
            tile.position = 1;
        } else {
            player.currentTot -= tile.bit;
            tile.position = 0;
        }
    };
    $window.onkeydown = function (event) {
        var key = event.keyCode;
        var playerKeys = [[49, 50, 51], //player 1
        [48, 189, 187], //player 2
        [90, 88, 67], //player 3
        [188, 190, 191] //player 4
        ];

        var left = [49, 48, 90, 188];
        var flip = [50, 189, 88, 190];
        var right = [51, 187, 67, 191];
        //determine player
        var currentPlayer;
        for (var i = 0; i < $scope.players.length; i++) {
            if (playerKeys[i].indexOf(key) !== -1) {
                currentPlayer = i;
                break;
            }
        }
        var playerObj = $scope.players[currentPlayer];

        //determine command
        if (left.indexOf(key) !== -1) {
            if (playerObj.activeTile + 1 === playerObj.board.length) {
                playerObj.activeTile = 0;
            } else {
                playerObj.activeTile += 1;
            }
            $scope.$digest();
        }
        if (flip.indexOf(key) !== -1) {
            var activeTileIndex = playerObj.board.length - playerObj.activeTile - 1;
            $scope.toggle(playerObj, playerObj.board[activeTileIndex]);
            $scope.$digest();
        }
        if (right.indexOf(key) !== -1) {
            if (playerObj.activeTile === 0) {
                playerObj.activeTile = playerObj.board.length - 1;
            } else {
                playerObj.activeTile -= 1;
            }
            $scope.$digest();
        }
    };
});
app.directive('tiles', function () {
    return {
        restrict: 'E',
        templateUrl: 'js/board/tiles.html'
    };
});

app.config(function ($stateProvider) {
    $stateProvider.state('board', {
        url: '/board/:bitChoice/:playerNum',
        templateUrl: 'js/board/board.html',
        controller: 'BoardCtrl',
        resolve: {
            players: function players($stateParams) {
                //creates an array for the players to be used in ng-repeat
                //creates the board object with individual tile info
                var tileCount = +$stateParams.bitChoice;
                var keyArray = [['1', '2', '3'], ['0', '-', '='], ['z', 'x', 'c'], [',', '.', '/']];
                var playersArray = [];
                for (var x = 0; x < $stateParams.playerNum; x++) {
                    var board = [];
                    for (var i = tileCount - 1; i >= 0; i--) {
                        var bit = Math.pow(2, i);
                        board.push({ index: i, bit: bit, position: 0 });
                    }

                    playersArray[x] = { playerID: x + 1,
                        currentTot: 0,
                        activeTile: tileCount - 1,
                        leftKey: keyArray[x][0],
                        toggleKey: keyArray[x][1],
                        rightKey: keyArray[x][2],
                        board: board };
                }
                return playersArray;
            },
            randomNum: function randomNum($stateParams) {
                //determine range of number based on bits chosen
                var x = Math.pow(2, Number($stateParams.bitChoice) - 1);
                var max = 0;
                while (x % 1 === 0) {
                    //while x is not a fraction
                    max += x;
                    x /= 2;
                }
                //create random num
                return Math.floor(Math.random() * max + 1);
            }
        }
    });
});
(function () {

    'use strict';

    // Hope you didn't forget Angular! Duh-doy.

    if (!window.angular) throw new Error('I can\'t find Angular!');
})();

app.controller('HomeCtrl', function ($scope, $state) {
    $scope.feedback = {}; //will contain .level and .playerCount
    console.log($scope.feedback);
});

app.config(function ($stateProvider) {
    $stateProvider.state('home', {
        url: '/',
        templateUrl: 'js/home/home.html',
        controller: 'HomeCtrl'
    });
});

app.controller('NavbarCtrl', function ($scope, $location, $state) {
    $scope.newGame = function () {
        var path = $location.path();
        var pathIndex = path.match(/\/board\/(\d+)\/(\d+)/);
        var level = pathIndex[1];
        var playerCount = pathIndex[2];
        $state.go('board', { bitChoice: level, playerNum: playerCount }, { reload: true });
    };
    $scope.nextLevel = function () {
        var path = $location.path();
        var pathIndex = path.match(/\/board\/(\d+)\/(\d+)/);
        var level = +pathIndex[1] + 1;
        var playerCount = pathIndex[2];
        $state.go('board', { bitChoice: level, playerNum: playerCount }, { reload: true });
    };
});
app.directive('navbar', function ($rootScope, $state) {

    return {
        restrict: 'E',
        scope: {},
        templateUrl: 'js/common/directives/navbar/navbar.html',
        controller: 'NavbarCtrl',
        link: function link(scope) {

            scope.items = [{ label: 'Home', state: 'home' }];
        }

    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImJvYXJkL2JvYXJkLmNvbnRyb2xsZXIuanMiLCJib2FyZC9ib2FyZC5kaXJlY3RpdmVzLmpzIiwiYm9hcmQvYm9hcmQuc3RhdGUuanMiLCJmc2EvZnNhLXByZS1idWlsdC5qcyIsImhvbWUvaG9tZS5jb250cm9sbGVyLmpzIiwiaG9tZS9ob21lLmpzIiwiY29tbW9uL2RpcmVjdGl2ZXMvbmF2YmFyL25hdmJhci5jb250cm9sbGVyLmpzIiwiY29tbW9uL2RpcmVjdGl2ZXMvbmF2YmFyL25hdmJhci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxPQUFBLEdBQUEsR0FBQSxRQUFBLE1BQUEsQ0FBQSx1QkFBQSxFQUFBLENBQUEsV0FBQSxFQUFBLGNBQUEsRUFBQSxXQUFBLENBQUEsQ0FBQTs7QUFFQSxJQUFBLE1BQUEsQ0FBQSxVQUFBLGtCQUFBLEVBQUEsaUJBQUEsRUFBQTs7QUFFQSxzQkFBQSxTQUFBLENBQUEsSUFBQTs7QUFFQSx1QkFBQSxTQUFBLENBQUEsR0FBQTtBQUVBLENBTkE7O0FDSEEsSUFBQSxVQUFBLENBQUEsV0FBQSxFQUFBLFVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQSxZQUFBLEVBQUEsT0FBQSxFQUFBLFNBQUEsRUFBQTs7QUFFQSxXQUFBLE9BQUEsR0FBQSxPQUFBLEM7QUFDQSxXQUFBLFNBQUEsR0FBQSxTQUFBLEM7QUFDQSxXQUFBLE9BQUEsR0FBQSxvQkFBQSxPQUFBLFNBQUE7QUFDQSxXQUFBLFdBQUEsR0FBQSxVQUFBLE1BQUEsRUFBQSxJQUFBLEVBQUE7QUFDQSxlQUFBLE9BQUEsVUFBQSxLQUFBLEtBQUEsS0FBQTtBQUNBLEtBRkE7O0FBSUEsV0FBQSxlQUFBLEdBQUEsVUFBQSxJQUFBLEVBQUE7QUFDQSxlQUFBLEtBQUEsUUFBQSxLQUFBLENBQUE7QUFDQSxLQUZBO0FBR0EsV0FBQSxhQUFBLEdBQUEsVUFBQSxNQUFBLEVBQUE7QUFDQSxZQUFBLE9BQUEsVUFBQSxLQUFBLE9BQUEsU0FBQSxFQUFBO0FBQ0EsbUJBQUEsT0FBQSxHQUFBLG9CQUFBLE9BQUEsUUFBQSxHQUFBLEdBQUE7QUFDQSxtQkFBQSxJQUFBO0FBQ0EsU0FIQSxNQUdBO0FBQ0EsbUJBQUEsS0FBQTtBQUNBOztBQUVBLEtBUkE7O0FBVUEsV0FBQSxNQUFBLEdBQUEsVUFBQSxNQUFBLEVBQUEsSUFBQSxFQUFBO0FBQ0EsWUFBQSxLQUFBLFFBQUEsS0FBQSxDQUFBLEVBQUE7QUFDQSxtQkFBQSxVQUFBLElBQUEsS0FBQSxHQUFBO0FBQ0EsaUJBQUEsUUFBQSxHQUFBLENBQUE7QUFDQSxTQUhBLE1BR0E7QUFDQSxtQkFBQSxVQUFBLElBQUEsS0FBQSxHQUFBO0FBQ0EsaUJBQUEsUUFBQSxHQUFBLENBQUE7QUFDQTtBQUNBLEtBUkE7QUFTQSxZQUFBLFNBQUEsR0FBQSxVQUFBLEtBQUEsRUFBQTtBQUNBLFlBQUEsTUFBQSxNQUFBLE9BQUE7QUFDQSxZQUFBLGFBQUEsQ0FDQSxDQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxDQURBLEU7QUFFQSxTQUFBLEVBQUEsRUFBQSxHQUFBLEVBQUEsR0FBQSxDQUZBLEU7QUFHQSxTQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxDQUhBLEU7QUFJQSxTQUFBLEdBQUEsRUFBQSxHQUFBLEVBQUEsR0FBQSxDO0FBSkEsU0FBQTs7QUFPQSxZQUFBLE9BQUEsQ0FBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUFBLENBQUE7QUFDQSxZQUFBLE9BQUEsQ0FBQSxFQUFBLEVBQUEsR0FBQSxFQUFBLEVBQUEsRUFBQSxHQUFBLENBQUE7QUFDQSxZQUFBLFFBQUEsQ0FBQSxFQUFBLEVBQUEsR0FBQSxFQUFBLEVBQUEsRUFBQSxHQUFBLENBQUE7O0FBRUEsWUFBQSxhQUFBO0FBQ0EsYUFBQSxJQUFBLElBQUEsQ0FBQSxFQUFBLElBQUEsT0FBQSxPQUFBLENBQUEsTUFBQSxFQUFBLEdBQUEsRUFBQTtBQUNBLGdCQUFBLFdBQUEsQ0FBQSxFQUFBLE9BQUEsQ0FBQSxHQUFBLE1BQUEsQ0FBQSxDQUFBLEVBQUE7QUFDQSxnQ0FBQSxDQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBQSxZQUFBLE9BQUEsT0FBQSxDQUFBLGFBQUEsQ0FBQTs7O0FBR0EsWUFBQSxLQUFBLE9BQUEsQ0FBQSxHQUFBLE1BQUEsQ0FBQSxDQUFBLEVBQUE7QUFDQSxnQkFBQSxVQUFBLFVBQUEsR0FBQSxDQUFBLEtBQUEsVUFBQSxLQUFBLENBQUEsTUFBQSxFQUFBO0FBQ0EsMEJBQUEsVUFBQSxHQUFBLENBQUE7QUFDQSxhQUZBLE1BRUE7QUFDQSwwQkFBQSxVQUFBLElBQUEsQ0FBQTtBQUNBO0FBQ0EsbUJBQUEsT0FBQTtBQUNBO0FBQ0EsWUFBQSxLQUFBLE9BQUEsQ0FBQSxHQUFBLE1BQUEsQ0FBQSxDQUFBLEVBQUE7QUFDQSxnQkFBQSxrQkFBQSxVQUFBLEtBQUEsQ0FBQSxNQUFBLEdBQUEsVUFBQSxVQUFBLEdBQUEsQ0FBQTtBQUNBLG1CQUFBLE1BQUEsQ0FBQSxTQUFBLEVBQUEsVUFBQSxLQUFBLENBQUEsZUFBQSxDQUFBO0FBQ0EsbUJBQUEsT0FBQTtBQUNBO0FBQ0EsWUFBQSxNQUFBLE9BQUEsQ0FBQSxHQUFBLE1BQUEsQ0FBQSxDQUFBLEVBQUE7QUFDQSxnQkFBQSxVQUFBLFVBQUEsS0FBQSxDQUFBLEVBQUE7QUFDQSwwQkFBQSxVQUFBLEdBQUEsVUFBQSxLQUFBLENBQUEsTUFBQSxHQUFBLENBQUE7QUFDQSxhQUZBLE1BRUE7QUFDQSwwQkFBQSxVQUFBLElBQUEsQ0FBQTtBQUNBO0FBQ0EsbUJBQUEsT0FBQTtBQUNBO0FBQ0EsS0E1Q0E7QUE4Q0EsQ0E3RUE7QUNBQSxJQUFBLFNBQUEsQ0FBQSxPQUFBLEVBQUEsWUFBQTtBQUNBLFdBQUE7QUFDQSxrQkFBQSxHQURBO0FBRUEscUJBQUE7QUFGQSxLQUFBO0FBSUEsQ0FMQTs7QUNBQSxJQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLG1CQUFBLEtBQUEsQ0FBQSxPQUFBLEVBQUE7QUFDQSxhQUFBLDhCQURBO0FBRUEscUJBQUEscUJB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QSxVQUFBLElBQUEsRUFBQTtBQUNBLFlBQUEsWUFBQSxLQUFBLEtBQUEsQ0FBQSx1QkFBQSxDQUFBO0FBQ0EsWUFBQSxRQUFBLENBQUEsVUFBQSxDQUFBLENBQUEsR0FBQSxDQUFBO0FBQ0EsWUFBQSxjQUFBLFVBQUEsQ0FBQSxDQUFBO0FBQ0EsZUFBQSxFQUFBLENBQUEsT0FBQSxFQUFBLEVBQUEsV0FBQSxLQUFBLEVBQUEsV0FBQSxXQUFBLEVBQUEsRUFBQSxFQUFBLFFBQUEsSUFBQSxFQUFBO0FBRUEsS0FQQTtBQVNBLENBakJBO0FDQUEsSUFBQSxTQUFBLENBQUEsUUFBQSxFQUFBLFVBQUEsVUFBQSxFQUFBLE1BQUEsRUFBQTs7QUFFQSxXQUFBO0FBQ0Esa0JBQUEsR0FEQTtBQUVBLGVBQUEsRUFGQTtBQUdBLHFCQUFBLHlDQUhBO0FBSUEsb0JBQUEsWUFKQTtBQUtBLGNBQUEsY0FBQSxLQUFBLEVBQUE7O0FBRUEsa0JBQUEsS0FBQSxHQUFBLENBQ0EsRUFBQSxPQUFBLE1BQUEsRUFBQSxPQUFBLE1BQUEsRUFEQSxDQUFBO0FBS0E7O0FBWkEsS0FBQTtBQWdCQSxDQWxCQSIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xud2luZG93LmFwcCA9IGFuZ3VsYXIubW9kdWxlKCdGdWxsc3RhY2tHZW5lcmF0ZWRBcHAnLCBbJ3VpLnJvdXRlcicsICd1aS5ib290c3RyYXAnLCAnbmdBbmltYXRlJ10pO1xuXG5hcHAuY29uZmlnKGZ1bmN0aW9uICgkdXJsUm91dGVyUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKSB7XG4gICAgLy8gVGhpcyB0dXJucyBvZmYgaGFzaGJhbmcgdXJscyAoLyNhYm91dCkgYW5kIGNoYW5nZXMgaXQgdG8gc29tZXRoaW5nIG5vcm1hbCAoL2Fib3V0KVxuICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTtcbiAgICAvLyBJZiB3ZSBnbyB0byBhIFVSTCB0aGF0IHVpLXJvdXRlciBkb2Vzbid0IGhhdmUgcmVnaXN0ZXJlZCwgZ28gdG8gdGhlIFwiL1wiIHVybC5cbiAgICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG5cbn0pO1xuXG4iLCJhcHAuY29udHJvbGxlcignQm9hcmRDdHJsJywgZnVuY3Rpb24oJHdpbmRvdywgJHNjb3BlLCAkc3RhdGVQYXJhbXMsIHBsYXllcnMsIHJhbmRvbU51bSl7XG5cblx0JHNjb3BlLnBsYXllcnMgPSBwbGF5ZXJzOyAvL2NyZWF0ZWQgaW4gdGhlIHN0YXRlIHJlc29sdmUgZnVuY3Rpb25cblx0JHNjb3BlLnRhcmdldE51bSA9IHJhbmRvbU51bTsgLy9kZXRlcm1pbmVkIGluIHRoZSBzdGF0ZSByZXNvbHZlIGZ1bmN0aW9uXG5cdCRzY29wZS5tZXNzYWdlID0gJ1RhcmdldCBOdW1iZXI6ICcrICRzY29wZS50YXJnZXROdW07XG5cdCRzY29wZS5jdXJyZW50VGlsZSA9IGZ1bmN0aW9uKHBsYXllciwgdGlsZSl7XG5cdFx0cmV0dXJuIHBsYXllci5hY3RpdmVUaWxlID09PSB0aWxlLmluZGV4O1xuXHR9O1xuXG4gICAkc2NvcGUuY3VycmVudFBvc2l0aW9uID0gZnVuY3Rpb24odGlsZSl7XG4gICAgICByZXR1cm4gdGlsZS5wb3NpdGlvbiA9PT0xO1xuICAgfTtcbiAgICRzY29wZS5jdXJyZW50V2lubmVyID0gZnVuY3Rpb24ocGxheWVyKXtcbiAgICAgIGlmKHBsYXllci5jdXJyZW50VG90ID09PSAkc2NvcGUudGFyZ2V0TnVtKXtcbiAgICAgICAgICRzY29wZS5tZXNzYWdlID0gJ1dpbm5lcjogUGxheWVyICcgKyBwbGF5ZXIucGxheWVySUQgKyAnISc7XG4gICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICAvLyByZXR1cm4gcGxheWVyLmN1cnJlbnRUb3QgPT09ICRzY29wZS50YXJnZXROdW07XG4gICB9O1xuXG5cdCRzY29wZS50b2dnbGUgPSBmdW5jdGlvbihwbGF5ZXIsIHRpbGUpe1xuXHRcdGlmKHRpbGUucG9zaXRpb249PT0wKXtcblx0XHRcdHBsYXllci5jdXJyZW50VG90ICs9IHRpbGUuYml0O1xuXHRcdFx0dGlsZS5wb3NpdGlvbj0xO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRwbGF5ZXIuY3VycmVudFRvdCAtPSB0aWxlLmJpdDtcblx0XHRcdHRpbGUucG9zaXRpb249MDtcblx0XHR9XG5cdH07XG5cdCR3aW5kb3cub25rZXlkb3duID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgIFx0XHR2YXIga2V5ID0gZXZlbnQua2V5Q29kZTtcbiAgIFx0XHR2YXIgcGxheWVyS2V5cyA9IFtcbiAgIFx0XHRcdFx0XHRcdFx0ICBbNDksNTAsNTFdLFx0XHQvL3BsYXllciAxXG5cdFx0XHRcdFx0XHRcdCAgICAgWzQ4LDE4OSwxODddLFx0Ly9wbGF5ZXIgMlxuICAgXHRcdFx0XHRcdFx0XHQgIFs5MCw4OCw2N10sXHRcdC8vcGxheWVyIDNcbiAgIFx0XHRcdFx0XHRcdFx0ICBbMTg4LDE5MCwxOTFdXHQvL3BsYXllciA0XG4gICBcdFx0XHRcdFx0XHQgICBdO1xuXG4gICBcdFx0dmFyIGxlZnQgPSBbNDksNDgsOTAsMTg4XTtcbiAgIFx0XHR2YXIgZmxpcCA9IFs1MCwxODksODgsMTkwXTtcbiAgIFx0XHR2YXIgcmlnaHQgPSBbNTEsMTg3LDY3LDE5MV07XG4gICBcdFx0Ly9kZXRlcm1pbmUgcGxheWVyXG4gICBcdFx0dmFyIGN1cnJlbnRQbGF5ZXI7XG4gICBcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCAkc2NvcGUucGxheWVycy5sZW5ndGg7IGkrKykge1xuICAgXHRcdFx0aWYocGxheWVyS2V5c1tpXS5pbmRleE9mKGtleSkgIT09IC0xKXtcbiAgIFx0XHRcdFx0Y3VycmVudFBsYXllciA9IGk7XG4gICBcdFx0XHRcdGJyZWFrO1xuICAgXHRcdFx0fVxuICAgXHRcdH1cbiAgIFx0XHR2YXIgcGxheWVyT2JqID0gJHNjb3BlLnBsYXllcnNbY3VycmVudFBsYXllcl07XG5cbiAgIFx0XHQvL2RldGVybWluZSBjb21tYW5kXG4gICBcdFx0aWYobGVmdC5pbmRleE9mKGtleSkgIT09IC0xKXtcbiAgIFx0XHRcdGlmKHBsYXllck9iai5hY3RpdmVUaWxlKzEgPT09IHBsYXllck9iai5ib2FyZC5sZW5ndGgpe1xuICAgXHRcdFx0XHRwbGF5ZXJPYmouYWN0aXZlVGlsZT0wO1xuICAgXHRcdFx0fSBlbHNlIHtcbiAgIFx0XHRcdFx0cGxheWVyT2JqLmFjdGl2ZVRpbGUrPTE7XG4gICBcdFx0XHR9XG4gICBcdFx0XHQkc2NvcGUuJGRpZ2VzdCgpO1xuICAgXHRcdH1cbiAgIFx0XHRpZihmbGlwLmluZGV4T2Yoa2V5KSAhPT0gLTEpe1xuICAgXHRcdFx0dmFyIGFjdGl2ZVRpbGVJbmRleCA9IHBsYXllck9iai5ib2FyZC5sZW5ndGgtcGxheWVyT2JqLmFjdGl2ZVRpbGUtMTtcbiAgIFx0XHRcdCRzY29wZS50b2dnbGUocGxheWVyT2JqLCBwbGF5ZXJPYmouYm9hcmRbYWN0aXZlVGlsZUluZGV4XSk7XG4gICBcdFx0XHQkc2NvcGUuJGRpZ2VzdCgpO1xuICAgXHRcdH1cbiAgIFx0XHRpZihyaWdodC5pbmRleE9mKGtleSkgIT09IC0xKXtcbiAgIFx0XHRcdGlmKHBsYXllck9iai5hY3RpdmVUaWxlID09PSAwKXtcbiAgIFx0XHRcdFx0cGxheWVyT2JqLmFjdGl2ZVRpbGUgPSBwbGF5ZXJPYmouYm9hcmQubGVuZ3RoLTE7XG4gICBcdFx0XHR9IGVsc2Uge1xuICAgXHRcdFx0XHRwbGF5ZXJPYmouYWN0aXZlVGlsZS09MTtcbiAgIFx0XHRcdH1cbiAgIFx0XHRcdCRzY29wZS4kZGlnZXN0KCk7XG4gICBcdFx0fVxuXHR9O1xuXG59KTsiLCJhcHAuZGlyZWN0aXZlKCd0aWxlcycsIGZ1bmN0aW9uKCl7XG5cdHJldHVybiB7XG5cdFx0cmVzdHJpY3Q6ICdFJyxcblx0XHR0ZW1wbGF0ZVVybDogJ2pzL2JvYXJkL3RpbGVzLmh0bWwnXG5cdH07XG59KTtcbiIsImFwcC5jb25maWcoZnVuY3Rpb24gKCRzdGF0ZVByb3ZpZGVyKSB7XG4gICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2JvYXJkJywge1xuICAgICAgICB1cmw6ICcvYm9hcmQvOmJpdENob2ljZS86cGxheWVyTnVtJyxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy9ib2FyZC9ib2FyZC5odG1sJyxcbiAgICAgICAgY29udHJvbGxlcjogJ0JvYXJkQ3RybCcsXG4gICAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgXHRwbGF5ZXJzOiBmdW5jdGlvbigkc3RhdGVQYXJhbXMpeyAvL2NyZWF0ZXMgYW4gYXJyYXkgZm9yIHRoZSBwbGF5ZXJzIHRvIGJlIHVzZWQgaW4gbmctcmVwZWF0XG4gICAgICAgIFx0XHQgLy9jcmVhdGVzIHRoZSBib2FyZCBvYmplY3Qgd2l0aCBpbmRpdmlkdWFsIHRpbGUgaW5mb1xuICAgICAgICAgICAgICAgIHZhciB0aWxlQ291bnQgPSArJHN0YXRlUGFyYW1zLmJpdENob2ljZTtcbiAgICAgICAgICAgICAgICB2YXIga2V5QXJyYXkgPSBbWycxJywnMicsJzMnXSwgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsnMCcsJy0nLCc9J10sIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbJ3onLCd4JywnYyddLCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWycsJywnLicsJy8nXV07XG4gICAgICAgICAgICAgICAgdmFyIHBsYXllcnNBcnJheSA9IFtdO1xuICAgICAgICBcdFx0Zm9yICh2YXIgeCA9IDA7IHggPCAkc3RhdGVQYXJhbXMucGxheWVyTnVtOyB4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJvYXJkID0gW107XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aWxlQ291bnQtMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiaXQgPSBNYXRoLnBvdygyLGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQucHVzaCh7aW5kZXg6IGksIGJpdDogYml0LCBwb3NpdGlvbjogMH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcGxheWVyc0FycmF5W3hdID0geyBwbGF5ZXJJRDogeCsxLCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VG90OiAwLCBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVUaWxlOiB0aWxlQ291bnQtMSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0S2V5OiBrZXlBcnJheVt4XVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2dnbGVLZXk6a2V5QXJyYXlbeF1bMV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRLZXk6a2V5QXJyYXlbeF1bMl0sIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkOiBib2FyZH07XG4gICAgICAgIFx0XHR9XG4gICAgICAgIFx0XHRyZXR1cm4gcGxheWVyc0FycmF5O1xuICAgICAgICBcdH0sXG4gICAgICAgICAgICByYW5kb21OdW06IGZ1bmN0aW9uKCRzdGF0ZVBhcmFtcyl7XG4gICAgICAgICAgICAgICAgLy9kZXRlcm1pbmUgcmFuZ2Ugb2YgbnVtYmVyIGJhc2VkIG9uIGJpdHMgY2hvc2VuXG4gICAgICAgICAgICAgICAgdmFyIHggPSBNYXRoLnBvdygyLE51bWJlcigkc3RhdGVQYXJhbXMuYml0Q2hvaWNlKS0xKTtcbiAgICAgICAgICAgICAgICB2YXIgbWF4ID0gMDtcbiAgICAgICAgICAgICAgICB3aGlsZSh4ICUgMSA9PT0gMCl7IC8vd2hpbGUgeCBpcyBub3QgYSBmcmFjdGlvblxuICAgICAgICAgICAgICAgICAgICBtYXggKz0geDtcbiAgICAgICAgICAgICAgICAgICAgeCAvPSAyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgLy9jcmVhdGUgcmFuZG9tIG51bVxuICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKChNYXRoLnJhbmRvbSgpICogbWF4KSArIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG59KTsiLCIoZnVuY3Rpb24gKCkge1xuXG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgLy8gSG9wZSB5b3UgZGlkbid0IGZvcmdldCBBbmd1bGFyISBEdWgtZG95LlxuICAgIGlmICghd2luZG93LmFuZ3VsYXIpIHRocm93IG5ldyBFcnJvcignSSBjYW5cXCd0IGZpbmQgQW5ndWxhciEnKTtcblxufSkoKTtcbiIsImFwcC5jb250cm9sbGVyKCdIb21lQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJHN0YXRlKXtcblx0JHNjb3BlLmZlZWRiYWNrID0ge30gLy93aWxsIGNvbnRhaW4gLmxldmVsIGFuZCAucGxheWVyQ291bnRcblx0Y29uc29sZS5sb2coJHNjb3BlLmZlZWRiYWNrKTtcbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcbiAgICAkc3RhdGVQcm92aWRlci5zdGF0ZSgnaG9tZScsIHtcbiAgICAgICAgdXJsOiAnLycsXG4gICAgICAgIHRlbXBsYXRlVXJsOiAnanMvaG9tZS9ob21lLmh0bWwnLFxuICAgICAgICBjb250cm9sbGVyOiAnSG9tZUN0cmwnXG4gICAgfSk7XG59KTtcbiIsImFwcC5jb250cm9sbGVyKCdOYXZiYXJDdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkbG9jYXRpb24sICRzdGF0ZSl7XG5cdCRzY29wZS5uZXdHYW1lID0gZnVuY3Rpb24oKXtcblx0XHR2YXIgcGF0aCA9ICRsb2NhdGlvbi5wYXRoKCk7XG5cdFx0dmFyIHBhdGhJbmRleCA9IHBhdGgubWF0Y2goL1xcL2JvYXJkXFwvKFxcZCspXFwvKFxcZCspLyk7XHRcblx0XHR2YXIgbGV2ZWwgPSBwYXRoSW5kZXhbMV07XG5cdFx0dmFyIHBsYXllckNvdW50ID0gcGF0aEluZGV4WzJdO1xuXHRcdCRzdGF0ZS5nbygnYm9hcmQnLCB7Yml0Q2hvaWNlOiBsZXZlbCwgcGxheWVyTnVtOiBwbGF5ZXJDb3VudH0sIHtyZWxvYWQ6IHRydWV9KTtcblx0fTtcblx0JHNjb3BlLm5leHRMZXZlbCA9IGZ1bmN0aW9uKCl7XG5cdFx0dmFyIHBhdGggPSAkbG9jYXRpb24ucGF0aCgpO1xuXHRcdHZhciBwYXRoSW5kZXggPSBwYXRoLm1hdGNoKC9cXC9ib2FyZFxcLyhcXGQrKVxcLyhcXGQrKS8pO1x0XG5cdFx0dmFyIGxldmVsID0gK3BhdGhJbmRleFsxXSArMTtcblx0XHR2YXIgcGxheWVyQ291bnQgPSBwYXRoSW5kZXhbMl07XG5cdFx0JHN0YXRlLmdvKCdib2FyZCcsIHtiaXRDaG9pY2U6IGxldmVsLCBwbGF5ZXJOdW06IHBsYXllckNvdW50fSwge3JlbG9hZDogdHJ1ZX0pO1xuXG5cdH07XG5cbn0pOyIsImFwcC5kaXJlY3RpdmUoJ25hdmJhcicsIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkc3RhdGUpIHtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3RyaWN0OiAnRScsXG4gICAgICAgIHNjb3BlOiB7fSxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy9jb21tb24vZGlyZWN0aXZlcy9uYXZiYXIvbmF2YmFyLmh0bWwnLFxuICAgICAgICBjb250cm9sbGVyOiAnTmF2YmFyQ3RybCcsXG4gICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSkge1xuXG4gICAgICAgICAgICBzY29wZS5pdGVtcyA9IFtcbiAgICAgICAgICAgICAgICB7IGxhYmVsOiAnSG9tZScsIHN0YXRlOiAnaG9tZScgfVxuICAgICAgICAgICAgXTtcblxuXG4gICAgICAgIH1cblxuICAgIH07XG5cbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
